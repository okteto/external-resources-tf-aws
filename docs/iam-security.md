# Dedicated IAM Resources for Enhanced Security

## Overview

This application now uses dedicated IAM resources instead of reusing shared AWS credentials from environment variables. This approach provides better security isolation and follows the principle of least privilege.

## What Changed

### 1. Dedicated IAM User
- **Resource**: `aws_iam_user.app_user`
- **Name**: `${bucket_name}-app-user`
- **Purpose**: Dedicated user for this specific application instance

### 2. Minimal IAM Policy
- **Resource**: `aws_iam_policy.app_policy`
- **Name**: `${bucket_name}-app-policy`
- **Permissions**:
  - **S3**: `GetObject`, `PutObject`, `DeleteObject`, `ListBucket` on the specific bucket only
  - **SQS**: `SendMessage`, `ReceiveMessage`, `DeleteMessage`, `GetQueueAttributes` on the specific queue only

### 3. Access Keys
- **Resource**: `aws_iam_access_key.app_access_key`
- **Usage**: Automatically generated and used by the application
- **Security**: Keys are managed by Terraform and cleaned up on destroy

## Security Benefits

1. **Principle of Least Privilege**: The IAM policy grants only the minimum permissions required
2. **Resource Isolation**: Permissions are scoped to specific S3 bucket and SQS queue
3. **Automatic Cleanup**: IAM resources are automatically deleted when the environment is destroyed
4. **No Shared Credentials**: Each environment gets its own dedicated IAM user and keys

## Lifecycle Management

### Deploy
1. Terraform creates the IAM user, policy, and access keys
2. The access keys are retrieved from Terraform outputs
3. A Kubernetes secret is created with the dedicated credentials
4. Applications use these dedicated credentials

### Destroy
1. Terraform destroys all IAM resources (user, policy, access keys)
2. The Kubernetes secret is also cleaned up
3. No IAM resources are left behind

## Migration from Environment Variables

**Before**: The application used shared AWS credentials from environment variables:
- `AWS_ACCESS_KEY_ID`
- `AWS_SECRET_ACCESS_KEY`

**After**: The application uses dedicated credentials generated by Terraform:
- `DEDICATED_AWS_ACCESS_KEY_ID`
- `DEDICATED_AWS_SECRET_ACCESS_KEY`

The original environment variables are still required during the deployment process to allow Terraform to create the dedicated IAM resources, but they are not used by the application itself.

## Monitoring and Troubleshooting

### Check IAM Resources
```bash
# List IAM users created by this application
aws iam list-users --query 'Users[?contains(UserName, `oktacoshop`)]'

# Check IAM policies
aws iam list-policies --scope Local --query 'Policies[?contains(PolicyName, `oktacoshop`)]'
```

### Verify Kubernetes Secret
```bash
kubectl get secret aws-credentials -n ${OKTETO_NAMESPACE} -o yaml
```

### Terraform Outputs
```bash
terraform output iam_access_key_id
terraform output iam_secret_access_key
```

## Best Practices Implemented

1. **Tagging**: All IAM resources are tagged for easy identification and management
2. **Naming Convention**: Resources follow a consistent naming pattern
3. **Force Destroy**: S3 bucket has `force_destroy = true` to ensure clean teardown
4. **Sensitive Outputs**: Secret access key is marked as sensitive in Terraform
5. **Error Handling**: Destroy command includes `--ignore-not-found=true` for idempotent cleanup