# file: .github/workflows/preview.yaml
on:
  pull_request:
    branches:
      - main

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [menu-unit, kitchen-unit, check-unit]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Context
      uses: okteto/context@latest
      with:
        url: ${{secrets.OKTETO_URL}}
        token: ${{ secrets.OKTETO_TOKEN }}

    - name: Run ${{ matrix.service }} Tests
      uses: okteto/test@latest
      with:
        tests: ${{ matrix.service }}

    - name: Save test artifacts for ${{ matrix.service }}
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: ${{ matrix.service }}-artifacts
        path: |
          menu/coverage/
          kitchen/coverage.out
          kitchen/coverage.html
          check/coverage.xml
          check/htmlcov/
        retention-days: 30

  test-summary:
    runs-on: ubuntu-latest
    needs: unit-tests
    if: always()
    steps:
    - name: Generate Test Summary
      run: |
        echo "## ðŸ§ª Unit Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ needs.unit-tests.result }}" == "success" ]; then
          echo "âœ… All unit tests passed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "- Menu Service (Node.js/Express): âœ… PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- Kitchen Service (Go/Gin): âœ… PASSED" >> $GITHUB_STEP_SUMMARY
          echo "- Check Service (Python/FastAPI): âœ… PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Some unit tests failed. Check the logs above." >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š **Total Tests**: 33 tests across 3 microservices" >> $GITHUB_STEP_SUMMARY

  preview:
    runs-on: ubuntu-latest
    needs: [unit-tests, test-summary]
    steps:
    - name: Context
      uses: okteto/context@latest
      with:
        url: ${{secrets.OKTETO_URL}}
        token: ${{ secrets.OKTETO_TOKEN }}

    - name: Deploy preview environment
      uses: okteto/deploy-preview@latest
      env:
       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        name: oktaco-pr-${{ github.event.number }}
        timeout: 15m
        
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run end to end tests
      uses: okteto/test@latest
      with:
        tests: e2e
        namespace: oktaco-pr-${{ github.event.number }}
        
    - name: Save playwright report
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: e2e/playwright-report/
        retention-days: 30
        
    - name: Save test results
      uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
          name: test-results
          path: e2e/test-results/
          retention-days: 30
          include-hidden-files: true
